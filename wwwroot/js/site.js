// Please see documentation at https://learn.microsoft.com/aspnet/core/client-side/bundling-and-minification
// for details on configuring this project to bundle and minify static web assets.


//Initialize required items (these are run as top-level statements)
CodeMirror(document.querySelector('#editor'), {
	lineNumbers: true,
	tabSize: 2,
	lineWrapping: true,
	value:
		`
group: "b62"
name: "lowes-home-improvement"
version: "3"
subfolder: "300-commercial"
info:
  summary: "Ploppable and growable home improvement and hardware store"
  description: |
    Lowe's Companies, Inc. is an American company that operates a chain of retail home improvement and appliance store. Founded in 1946 in North Wilkesboro, North Carolina, the chain has 1,840 stores in the United States, Canada, and Mexico. Lowe's is the second-largest hardware chain in the United States behind The Home Depot and ahead of Menards. Globally, Lowe's is also the second-largest hardware chain, again behind The Home Depot but ahead of the European stores B&Q and OBI.

    This BAT was originally created by Bobbo662 (aka B62). Unfortunately, due to real life circumstances, he was unable to finish the lot and was just sitting around on his hard drive. After talking with him, he graciously handed his work over to me to finish and subsequently upload for yall.

    Lowes Home Improvement: 12x12 CS$ Plop & Grow
         Jobs : 2968 CS$, 744 CS$
         Plop Cost : $65000
         Bulldoze Cost : $6500
         Power Consumed : 60
         Water Consumed : 716
         Air Pollution : 37 over 5 tiles
         Water Pollution : 18 over 6 tiles
         Garbage Pollution : 37 over 0 tiles
         Flammability : 40
  author: "Bobbo662, nos.17"
  images:
  - "http://nos17.weebly.com/uploads/2/6/0/3/26032074/a1_2_orig.png"
  - "http://nos17.weebly.com/uploads/2/6/0/3/26032074/a0_orig.png"
  - "http://nos17.weebly.com/uploads/2/6/0/3/26032074/a4_orig.png"
  - "http://nos17.weebly.com/uploads/2/6/0/3/26032074/a6_orig.png"
  - "http://nos17.weebly.com/uploads/2/6/0/3/26032074/a7_orig.png"
  - "http://nos17.weebly.com/uploads/2/6/0/3/26032074/a8_orig.png"
  - "http://nos17.weebly.com/uploads/2/6/0/3/26032074/a9_orig.png"
  - "http://nos17.weebly.com/uploads/2/6/0/3/26032074/b4_2_orig.png"
  website: "https://community.simtropolis.com/files/file/30942-b62-remastered-lowes-home-improvement-distribution-centers/"
dependencies:
- "bsc:textures-vol01"
- "bsc:mega-props-sg-vol01"
- "shk:parking-pack"
- "bsc:mega-props-jes-vol01"
- "bsc:mega-props-jes-vol02"
assets:
- assetId: "b62-lowes-home-improvement-and-distribution"

---
group: "b62"
name: "lowes-distribution-center"
version: "3"
subfolder: "400-industrial"
info:
  summary: "Ploppable and growable industrial distribtion warehouse"
  description: >
    Lowe's Companies, Inc. is an American company that operates a chain of retail home improvement and appliance store. Founded in 1946 in North Wilkesboro, North Carolina, the chain has 1,840 stores in the United States, Canada, and Mexico. Lowe's is the second-largest hardware chain in the United States behind The Home Depot and ahead of Menards. Globally, Lowe's is also the second-largest hardware chain, again behind The Home Depot but ahead of the European stores B&Q and OBI.

    This BAT was originally created by Bobbo662 (aka B62). Unfortunately, due to real life circumstances, he was unable to finish the lot and was just sitting around on his hard drive. After talking with him, he graciously handed his work over to me to finish and subsequently upload for yall.

    Lowes Distribution Center: 13x11 IM Plop & Grow
         Jobs : 808 IM
         Plop Cost : $55000
         Bulldoze Cost : $5500
         Power Consumed : 39
         Water Consumed : 572
         Air Pollution : 38 over 9 tiles
         Water Pollution : 25 over 13 tiles
         Garbage Pollution : Minimal
         Flammability : 70
  author: "Bobbo662, nos.17"
  images:
  - "https://www.simtropolis.com/objects/screens/monthly_2024_08/lowes-wh-0.png.8fbeebc5acfd7daa6d15d951e6251be3.png"
  - "https://www.simtropolis.com/objects/screens/monthly_2024_08/lowes-wh-1.png.c6695d7477596ade473e8e920bde5bc6.png"
  - "https://www.simtropolis.com/objects/screens/monthly_2024_08/lowes-wh-2.png.cef3048823f8088baca909a828876dc5.png"
  - "https://www.simtropolis.com/objects/screens/monthly_2024_08/lowes-wh-3.png.1a594b2b1b764e8f3aed899ff7c9785b.png"
  - "https://www.simtropolis.com/objects/screens/monthly_2024_08/lowes-wh-4.png.c2320085f956edf67dbc4ceb7e818d05.png"
  - "https://www.simtropolis.com/objects/screens/monthly_2024_08/lowes-wh-5.png.0ef1ea62065a2aa1fbea37f0405aa982.png"
  - "https://www.simtropolis.com/objects/screens/monthly_2024_08/lowes-dist-0.png.36e6e7f01022aa60c753b86461a838cd.png"
  - "https://www.simtropolis.com/objects/screens/monthly_2024_08/lowes-dist-1.png.4cbc21724343dea181bbc84fc298a32f.png"
  - "https://www.simtropolis.com/objects/screens/monthly_2024_08/lowes-dist-2.png.47e501fe741b8a13448c34e8576fd4aa.png"
  website: "https://community.simtropolis.com/files/file/30942-b62-remastered-lowes-home-improvement-distribution-centers/"
dependencies:
- "bsc:textures-vol01"
- "bsc:mega-props-sg-vol01"
- "shk:parking-pack"
- "bsc:mega-props-jes-vol01"
- "bsc:mega-props-jes-vol02"
assets:
- assetId: "b62-lowes-home-improvement-and-distribution"


---
url: "https://community.simtropolis.com/files/file/30942-b62-remastered-lowes-home-improvement-distribution-centers/?do=download&r=202555"
assetId: "b62-lowes-home-improvement-and-distribution"
version: "3"
lastModified: "2017-06-21T01:53:11Z"
`,
	mode: 'yaml'
});

var currPackageIdx = '0';
var currAssetIdx = '0';
var pacAssets = new Array();
var pacPackages = new Array();
var sc4pacdata = FetchSc4pacData().then(result => {
	sc4pacdata = result.contents;
	pacAssets = result.contents.filter((item) => item.group === 'sc4pacAsset');
	pacPackages = result.contents.filter((item) => item.group !== 'sc4pacAsset');
});
//fetch('/config.json').then(function (config) {
//    console.log('API key:', config.apiKey);
//});


/**
 * Main Tree View
 */
var mtv;
/**
 * Asset Tree View
 */
var atv;
const cm = document.querySelector('.CodeMirror').CodeMirror;
var yamlData = null;
var countOfPackages = 0;
var countOfAssets = 0;
var listOfAssets = new Array();
var listOfPackages = new Array();
ParseYaml();
ClearAssetInputs();
ClearPackageInputs();
document.getElementById("PkgPropTab").click();

new TomSelect('#PacPackageList', {
	valueField: 'id',
	labelField: 'id',
	searchField: ['id'],

	// fetch remote data
	load: function (query, callback) {
		var self = this;
		if (self.loading > 1) {
			callback();
			return;
		}

		var url = 'https://memo33.github.io/sc4pac/channel/sc4pac-channel-contents.json'
		fetch(url)
			.then(response => response.json())
			.then(json => {
				//Filter the response to remove assets and add a new field combining the group and name
				callback(json.contents
					.filter((item) => item.group !== 'sc4pacAsset')
					.map(i => ({ id: i.group + ":" + i.name, ...i }))
				);
				console.log(json.contents
					.filter((item) => item.group !== 'sc4pacAsset')
					.map(i => ({ id: i.group + ":" + i.name, ...i }))
				);
				self.settings.load = null;
			}).catch(() => {
				callback();
			});
	},
	// custom rendering function for options
	render: {
		option: function (item, escape) {
			return '<div class="py-2 d-flex">' + escape(item.group + ":" + item.name)+ '</div>';
		}
	},
});



//TODO - validate YAML in code pane for valid yaml syntax
//TODO - validate YAML in code pane for valid sc4pac schema
//TODO - implement variants for packages


async function FetchSc4pacData() {
	const request = new Request('https://memo33.github.io/sc4pac/channel/sc4pac-channel-contents.json');
	const response = await fetch(request);
	return await response.json();
}
async function FetchSc4EvermoreData() {
	const request = new Request('https://www.sc4evermore.com/latest-modified-downloads.php');
	const response = await fetch(request);
	return await response.json();
}



/**
 * Parse the current YAML input and update the UI accordingly based on the count of packages and assets.
 */
function ParseYaml() {
	yamlData = jsyaml.loadAll(cm.getValue());
	CountItems();
	UpdateMainTree();
}



function UpdateMainTree() {
	var idx = 1;
	var astList = [];
	listOfAssets.forEach((asset) => {
		astList.push({ name: idx + ' - ' + asset.assetId, children: [] });
		idx++;
	});

	idx = 1;
	var pkgList = [];
	listOfPackages.forEach((pkg) => {
		pkgList.push({ name: idx + ' - ' + pkg.group + ":" + pkg.name, children: [] });
		idx++;
	});

	var mainTreeData = [
		{ name: 'Packages (' + pkgList.length + ')', expanded: true, children: pkgList },
		{ name: 'Assets (' + astList.length + ')', expanded: true, children: astList }
	];
	mtv = new TreeView(mainTreeData, 'MainTreeView');
	mtv.on("select", function (t) {
		if (t.data.name.indexOf(' - ') > 0) {
			if (t.data.name.indexOf(':' > 0)) {
				currPackageIdx = t.data.name.slice(0, t.data.name.indexOf(' '));
				FillPackageForm();
				UpdateAssetTree();
			} else {
				currAssetIdx = t.data.name.slice(0, t.data.name.indexOf(' '));
				FillAssetForm();
			}
		}
	});
}

function UpdateAssetTree() {
	var pkgAssets;
	var doc = GetCurrentDocument('p');
	if (doc == null) {
		pkgAssets = [];
	} else {
		pkgAssets = doc.assets.map((i) => ({ name: i.assetId, children: [] }));
	}

	var pkgAssetData = [{ name: 'Assets (' + pkgAssets.length + ')', expanded: true, children: pkgAssets }]
	atc = new TreeView(pkgAssetData, 'AssetTreeView');
	atc.on("select", function (t) {
		console.log(t);
		FillPackageAssetForm(t.data.name);
	});
}



/**
 * Count the number of Packages and Assets in the code pane and update the UI with this new result.
 */
function CountItems() {
	countOfAssets = 0;
	countOfPackages = 0;
	listOfAssets.length = 0;
	listOfPackages.length = 0;

	if (yamlData !== null) {
		yamlData.forEach((item) => {
			if (IsAsset(item)) {
				countOfAssets++;
				listOfAssets.push(item);
			} else if (IsPackage(item)) {
				countOfPackages++;
				listOfPackages.push(item);
			}
		});
	}

	//Package selection dropdown
	//var pkgElement = document.getElementById('SelectPackageNumber');
	//var currentValue = pkgElement.value;
	//pkgElement.replaceChildren();
	//pkgElement.appendChild(new Option('Create New Package', 0));
	//for (var idx = 0; idx < listOfPackages.length; idx++) {
	//	pkgElement.add(new Option(idx + 1 + ' - ' + listOfPackages[idx].group + ":" + listOfPackages[idx].name, idx + 1));
	//}
	//pkgElement.value = currentValue;

	//Asset selection dropdown
	//var assetElement = document.getElementById('SelectAssetNumber');
	//currentValue = assetElement.value;
	//assetElement.replaceChildren();
	//assetElement.appendChild(new Option('Create New Asset', 0));
	//for (var idx = 0; idx < listOfAssets.length; idx++) {
	//	assetElement.add(new Option(idx + 1 + ' - ' + listOfAssets[idx].assetId, idx + 1));
	//}
	//assetElement.value = currentValue;



	//Pachage dependency selection for local packages
	var localPkgList = document.getElementById('LocalPackageList');
	localPkgList.replaceChildren();
	localPkgList.appendChild(new Option('', ''));
	for (var idx = 0; idx < listOfPackages.length; idx++) {
		var pkgName = listOfPackages[idx].group + ":" + listOfPackages[idx].name;
		localPkgList.add(new Option(pkgName, pkgName));
	}

	//Package dependency selection for existing sc4pac packages
	//var pacPkgList = document.getElementById('PacPackageList');
	//pacPkgList.replaceChildren();
	//pacPkgList.appendChild(new Option('', ''));
	//console.log("pacPackages: " + pacPackages.length);
	//pacPackages.forEach(i => {
	//	var pkgName = i.group + ':' + i.name;
	//	pacPkgList.add(new Option(pkgName, pkgName));
	//});


	//Package:asset selection for local assets
	var localAssetList = document.getElementById('SelectLocalPackageAssets');
	localAssetList.replaceChildren();
	localAssetList.appendChild(new Option('', ''));
	listOfAssets.forEach(i => localAssetList.add(new Option(i.assetId, i.assetId)));

	//Package:asset selection for existing sc4pac assets
	var pacAssetList = document.getElementById('SelectPacPackageAssets');
	pacAssetList.replaceChildren();
	pacAssetList.appendChild(new Option('', ''));
	pacAssets.forEach(i => pacAssetList.add(new Option(i.name, i.name)));



	document.getElementById('CurrentItemCount').innerHTML = 'This file contains: ' + countOfPackages + ' packages, ' + countOfAssets + ' assets'
}


function UpdateCodePane() {
	var newYaml = '';
	var doc = '';
	//TODO - figure out how to retain comments

	for (var idx = 0; idx < yamlData.length; idx++) {
		if (yamlData[idx] === null) {
			continue;
		}
		doc = jsyaml.dump(yamlData[idx], {
			'lineWidth': -1,
			'quotingType': '"',
			'noArrayIndent': true,
			'forceQuotes': true
		});
		//The parser blows away the multiline context so we need to rebuild it :(
		if (doc.indexOf('description: ') > 0) {
			
			var rgx = new RegExp('description: \"(.*?)\"');
			var oldText = doc.match(rgx)[0];
			var newText = oldText.replace('description: "', "description: >\n    ").replaceAll('\\n', '\n    ').replace('"','');
			doc = doc.replace(oldText, newText);
		}

		newYaml = newYaml + doc;
		if (idx !== yamlData.length - 1) {
			newYaml = newYaml + '\n---\n';
		}
	}
	cm.setValue(newYaml);
}

/**
 * Navigate to the specified tab.
 */
function OpenTab(event, tabName) {
	var i, tablinks;

	// Get all elements with class="tabcontent" and hide them
	var tabcontent = document.getElementsByClassName("tabcontent");
	for (i = 0; i < tabcontent.length; i++) {
		tabcontent[i].style.display = "none";
	}

	// Get all elements with class="tablinks" and remove the class "active"
	tablinks = document.getElementsByClassName("tab-link");
	for (i = 0; i < tablinks.length; i++) {
		tablinks[i].className = tablinks[i].className.replace(" active", "");
	}

	// Show the current tab, and add an "active" class to the button that opened the tab
	document.getElementById(tabName).style.display = "block";
	event.currentTarget.className += " active";

	//Set the editing view to the desired state to show/hide the Package and Asset entry forms.
	if (tabName === 'AssetProperties') {
		document.getElementById('EditingPackageDiv').classList.add('invisible2');
		document.getElementById('EditingPackageDiv').classList.remove('visible2');
		document.getElementById('EditingAssetDiv').classList.remove('invisible2');
		document.getElementById('EditingAssetDiv').classList.add('visible2');
	} else {
		document.getElementById('EditingPackageDiv').classList.add('visible2');
		document.getElementById('EditingPackageDiv').classList.remove('invisible2');
		document.getElementById('EditingAssetDiv').classList.add('invisible2');
		document.getElementById('EditingAssetDiv').classList.remove('visible2');
	}
	if (tabName === 'PackageAssets' || tabName === 'PackageProperties') {
		//have to recount the items so we get the pacAssets/pacPackages arrays to fill
		CountItems();
	}

	//If the selected package is blank then select the first one if available
	//if (document.getElementById('SelectPackageNumber').value == 0 && countOfPackages > 0) {
	//	document.getElementById('SelectPackageNumber').value = "1";
	//	FillPackageForm();
	//}
}

function CopyToClipboard() {
	navigator.clipboard.writeText(cm.getValue())
}

function validate() {
	//ensure any manually typed yaml (as opposed to generated yaml) is syntactically valid
}